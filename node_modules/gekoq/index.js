const https = require('https');

const push = (api_key, widget) => {
  return new Promise((resolve, reject) => {
    const payload = JSON.stringify({ 
      api_key: api_key, 
      data: widget.data 
    });
    const options = {
      hostname: 'push.geckoboard.com', 
      port: 443, 
      path: '/v1/send/' + widget.key,
      method: 'POST', 
      headers: { 
        'Content-Type': 'application/json', 
        'Content-Length': Buffer.byteLength(payload) 
      }
    }
    const req = https.request(options, (res) => {
      res.setEncoding('utf8');
      let data = '';
      res.on('data', (chunk) => {
        data += chunk;
      });
      res.on('end', () => {
        return resolve({ 
          key: widget.key, 
          message: JSON.parse(data) 
        });
      });
    })
    req.on('error', (e) => reject(e));
    req.write(payload);
    req.end();
  });
}

const gekoq = (key) => (widget) => push(key, widget);

module.exports = gekoq;
